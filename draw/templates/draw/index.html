{% load static %}

<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>P4 Drawing</title>

    <link rel="stylesheet" type="text/css" href="{% static 'draw/vendor/bootstrap/css/bootstrap.min.css' %}">
    <script type="text/javascript" src="{% static 'draw/vendor/jquery/jquery-3.3.1.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'draw/vendor/paper/paper-full.min.js' %}"></script>

    <style type="text/css">
    </style>

</head>
<body>
    <!-- You may change the dimensions of this canvas -->
    <canvas id="myCanvas" width="750px" height="750px"></canvas>
</body>
<script>

    // setting up the canvas and one paper tool
    var canvas = document.getElementById('myCanvas');
    paper.setup(canvas);
    var tool = new paper.Tool();

    // getting the URL (you may want to use for Exercise 3)
    var url = window.location.href;

    var socket = new WebSocket(
        'wss://p3-websockets-ishanaraghuram-ishanaraghuram545937.codeanyapp.com/ws/draw');
      // triggered when receiving a message from the server
    var currPath = new paper.Path();
    var userColor = '#'+(0x1000000+(Math.random())*0xffffff).toString(16).substr(1,6);
    var currId = Math.random(10000);
    var paths = {};
  
   window.addEventListener('devicemotion', function(event) {
        if (event.acceleration.x > 2) {
          var context = canvas.getContext('2d');
          context.clearRect(0, 0, canvas.width, canvas.height);
          for (var index in paths) {
            paths[index].removeSegments();
            paths[index] = new paper.Path();
          }
        }
    });
  
  window.addEventListener('deviceorientation', function(event) {
        if (event.gamma > 45){
          var newColor = '#'+(0x1000000+(Math.random())*0xffffff).toString(16).substr(1,6);
          currPath.strokeColor = newColor;
          userColor = newColor;
        }
  });


    socket.onmessage = function(receivedMessage) {
      // do something when you receive a message
      var msg = JSON.parse(receivedMessage.data);
      var x = msg.x;
      var y = msg.y;
      var c = msg.color;
      var id = msg.id;
      
      if (url.indexOf('?size=large') > -1) {
        if (id in paths) {
          var p = paths[id];
          p.add(new paper.Point(x, y));
        }
        else {
          var otherPath = new paper.Path();
          otherPath.strokeColor = c;
          otherPath.strokeWidth = 5;
          otherPath.add(new paper.Point(x, y));
          paths[id] = otherPath;

        }
      }
    };
    var message;
    tool.onMouseMove = function(event) {
          currPath.strokeColor = userColor;
          currPath.strokeWidth = 5;
          currPath.add(event.point);
          var pointX = event.point.x;
          var pointY = event.point.y;
          message = JSON.stringify({x: pointX, y: pointY, id: currId, color: userColor}); // send ID with path
          socket.send(message);
    }; 
    
    // notify console if socket closes unexpectedly
    socket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };


</script>
</html>
